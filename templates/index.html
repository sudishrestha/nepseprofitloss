<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CSV Upload and Display</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="mb-4">Share Portfolio Dashboard</h1>
      <form id="csvForm" class="mb-4" onsubmit="return false;">
        <div class="row g-3 align-items-center">
          <div class="col-auto">
            <label for="wacc_file" class="form-label">WACC File</label>
            <input
              type="file"
              class="form-control"
              id="wacc_file"
              accept=".csv"
            />
          </div>
          <div class="col-auto">
            <label for="share_file" class="form-label">Share Value File</label>
            <input
              type="file"
              class="form-control"
              id="share_file"
              accept=".csv"
            />
          </div>
          <div class="col-auto align-self-end">
            <button
              type="button"
              class="btn btn-primary"
              onclick="handleFiles()"
            >
              Show Table
            </button>
          </div>
        </div>
      </form>
      <div id="alertNoData" class="alert alert-warning" style="display: none">
        No data uploaded yet.
      </div>
      <div
        id="tableContainer"
        class="table-responsive"
        style="display: none"
      ></div>
    </div>
    <style>
      .text-success {
        color: #27ae60 !important;
      }
      .text-danger {
        color: #e74c3c !important;
      }
      .text-info {
        color: #2980b9 !important;
      }
      .text-primary {
        color: #6c47ff !important;
      }
      .fw-bold {
        font-weight: bold;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script>
      function handleFiles() {
        const waccInput = document.getElementById("wacc_file");
        const shareInput = document.getElementById("share_file");
        const waccFile = waccInput.files[0];
        const shareFile = shareInput.files[0];
        if (!waccFile || !shareFile) {
          document.getElementById("alertNoData").style.display = "";
          document.getElementById("tableContainer").style.display = "none";
          return;
        }
        document.getElementById("alertNoData").style.display = "none";
        // Parse both CSVs
        Promise.all([
          new Promise((resolve) => {
            Papa.parse(waccFile, {
              header: true,
              complete: (results) => resolve(results.data),
            });
          }),
          new Promise((resolve) => {
            Papa.parse(shareFile, {
              header: true,
              complete: (results) => resolve(results.data),
            });
          }),
        ]).then(([waccData, shareData]) => {
          // Build scrip map
          const waccMap = {};
          waccData.forEach((row) => {
            if (row["Scrip Name"])
              waccMap[row["Scrip Name"].trim().toUpperCase()] = row;
          });
          // Prepare headers
          let headers = shareData.length ? Object.keys(shareData[0]) : [];
          headers = headers.concat([
            "Purchase Rate",
            "Purchase Total",
            "Profit/Loss",
            "% Profit/Loss",
          ]);
          let rows = [];
          let total_purchase = 0,
            total_profit_loss = 0;
          shareData.forEach((row) => {
            const scrip = (row["Scrip"] || row["Scrip Name"] || "")
              .trim()
              .toUpperCase();
            const waccRow = waccMap[scrip];
            const purchase_rate =
              waccRow && waccRow["WACC Rate"]
                ? parseFloat(waccRow["WACC Rate"])
                : 0;
            const qty =
              parseFloat(
                row["Current Balance"] || row["WACC Calculated Quantity"] || 0
              ) || 0;
            const ltp =
              parseFloat(
                row["Last Transaction Price (LTP)"] || row["LTP"] || 0
              ) || 0;
            const purchase_total = +(qty * purchase_rate).toFixed(2);
            const ltp_total = +(qty * ltp).toFixed(2);
            const profit_loss = +(ltp_total - purchase_total).toFixed(2);
            const percent_profit_loss = purchase_total
              ? +((profit_loss / purchase_total) * 100).toFixed(2)
              : 0;
            total_purchase += purchase_total;
            total_profit_loss += profit_loss;
            const rowOut = headers
              .slice(0, -4)
              .map((h) => row[h] || "")
              .concat([
                purchase_rate ? purchase_rate.toFixed(2) : "",
                purchase_total,
                profit_loss,
                percent_profit_loss,
              ]);
            rows.push(rowOut);
          });
          const total_percent_profit_loss = total_purchase
            ? ((total_profit_loss / total_purchase) * 100).toFixed(2) +
              "asdfasd"
            : "0.00";
          // Render table
          let html =
            '<table class="table table-bordered table-striped"><thead><tr>';
          headers.forEach((h) => (html += `<th>${h}</th>`));
          html += "</tr></thead><tbody>";
          const profLossIdx = headers.length - 1; // % Profit/Loss column index
          rows.forEach((row) => {
            html += "<tr>";
            row.forEach((cell, idx) => {
              if (idx === profLossIdx) {
                let color = "text-primary";
                let val = parseFloat(cell);
                if (val < 0) color = "text-danger";
                else if (val > 0) color = "text-success";
                else if (val === 0) color = "text-info";
                html += `<td class="fw-bold ${color}">${cell}%</td>`;
              } else {
                html += `<td>${cell}</td>`;
              }
            });
            html += "</tr>";
          });
          html += "</tbody>";
          // Only one totals row in tfoot
          html += "<tfoot><tr>";
          html += `<th colspan="${
            headers.length - 3
          }" class="text-end">Totals</th>`;
          html += `<th>${total_purchase.toFixed(
            2
          )}</th><th>${total_profit_loss.toFixed(2)}</th>`;
          let totalColor = "text-primary";
          let totalVal = parseFloat(total_percent_profit_loss);
          if (totalVal < 0) totalColor = "text-danger";
          else if (totalVal > 0) totalColor = "text-success";
          else if (totalVal === 0) totalColor = "text-info";
          html += `<th class="fw-bold ${totalColor}">${total_percent_profit_loss}%</th>`;
          html += "</tr></tfoot>";
          html += "</table>";
          document.getElementById("tableContainer").innerHTML = html;
          document.getElementById("tableContainer").style.display = "";
        });
      }
    </script>
  </body>
</html>
